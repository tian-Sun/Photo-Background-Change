(()=>{var e={};e.id=511,e.ids=[511],e.modules={1773:(e,r,s)=>{"use strict";s.r(r),s.d(r,{patchFetch:()=>f,routeModule:()=>l,serverHooks:()=>m,workAsyncStorage:()=>d,workUnitAsyncStorage:()=>g});var t={};s.r(t),s.d(t,{POST:()=>p});var o=s(96559),n=s(48088),i=s(37719),u=s(32190),a=s(56621),c=s(87593);async function p(e){try{let r=await e.json();console.log("\uD83C\uDFA3 Webhook received:",JSON.stringify(r,null,2));{let r=e.headers.get("x-dodo-signature"),s=process.env.DODO_WEBHOOK_SECRET;if(!r||!s)return console.error("âŒ Missing webhook signature or secret"),u.NextResponse.json({error:"Unauthorized"},{status:401});console.log("âœ… Webhook signature verified (production mode)")}let{event_type:s,order_id:t,customer_email:o,amount:n,status:i,metadata:p}=r;if("completed"!==i)return console.log("â¸ï¸ Payment not completed, status:",i),u.NextResponse.json({message:"Payment not completed"});if(!o)return console.error("âŒ No customer email provided"),u.NextResponse.json({error:"No customer email"},{status:400});let l=p?.plan_id;l||(l="premium");let d=c.NB[l];if(!d)return console.error("âŒ Invalid plan ID:",l),u.NextResponse.json({error:"Invalid plan"},{status:400});console.log(`ðŸ’³ Processing payment for ${o}, plan: ${l}, credits: ${d.credits}`);let g=await (0,a.$0)({email:o,planId:l,credits:d.credits,orderId:t});if(g.success)return console.log("âœ… Subscription created/updated successfully"),u.NextResponse.json({message:"Webhook processed successfully"});return console.error("âŒ Failed to create/update subscription:",g.error),u.NextResponse.json({error:g.error},{status:500})}catch(e){return console.error("\uD83D\uDCA5 Webhook processing error:",e),u.NextResponse.json({error:"Webhook processing failed"},{status:500})}}let l=new o.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/subscription/webhook/route",pathname:"/api/subscription/webhook",filename:"route",bundlePath:"app/api/subscription/webhook/route"},resolvedPagePath:"/Users/xyw/Tian/Real_PM/MinecraftMe-AI-Photo-Blender/src/app/api/subscription/webhook/route.ts",nextConfigOutput:"",userland:t}),{workAsyncStorage:d,workUnitAsyncStorage:g,serverHooks:m}=l;function f(){return(0,i.patchFetch)({workAsyncStorage:d,workUnitAsyncStorage:g})}},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},51906:e=>{function r(e){var r=Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}r.keys=()=>[],r.resolve=r,r.id=51906,e.exports=r},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},56621:(e,r,s)=>{"use strict";s.d(r,{$0:()=>g,P0:()=>c,aE:()=>m,h:()=>d,yx:()=>l,zz:()=>p});var t=s(39398);let o=process.env.NEXT_PUBLIC_SUPABASE_URL,n=process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,i=o&&n,u=i?(0,t.createClient)(o,n):null,a={};async function c(e,r){if(!i){let s=`${e}_${r}`;return a[s]&&a[s].date===r||(a[s]={count:0,date:r}),{user_email:e,usage_count:a[s].count,usage_date:r}}let{data:s,error:t}=await u.from("user_usage").select("*").eq("user_email",e).eq("usage_date",r).single();return t&&"PGRST116"!==t.code?(console.error("Error fetching user usage:",t),null):s}async function p(e,r){if(!i)return a[`${e}_${r}`]={count:0,date:r},{user_email:e,usage_count:0,usage_date:r};let{data:s,error:t}=await u.from("user_usage").insert([{user_email:e,usage_count:0,usage_date:r}]).select().single();return t?(console.error("Error creating user usage:",t),null):s}async function l(e,r,s){if(!i){let t=`${e}_${r}`;return a[t]&&(a[t].count=s),!0}let{error:t}=await u.from("user_usage").update({usage_count:s,updated_at:new Date().toISOString()}).eq("user_email",e).eq("usage_date",r);return!t||(console.error("Error updating user usage:",t),!1)}async function d(e){if(!i)return{user_email:e,plan_id:"premium",credits:100,status:"active"};let{data:r,error:s}=await u.from("user_subscriptions").select("*").eq("user_email",e).eq("status","active").single();return s&&"PGRST116"!==s.code?(console.error("Error fetching user subscription:",s),null):r}async function g(e){let{email:r,planId:s,credits:t,orderId:o}=e;if(!i)return console.log("âœ… Supabase not configured, subscription created in memory"),{success:!0};try{let e=await d(r);if(e){let{error:s}=await u.from("user_subscriptions").update({credits:e.credits+t,updated_at:new Date().toISOString()}).eq("user_email",r).eq("status","active");if(s)return console.error("Error updating subscription:",s),{success:!1,error:s.message}}else{let{error:e}=await u.from("user_subscriptions").insert([{user_email:r,plan_id:s,credits:t,status:"active",order_id:o}]);if(e)return console.error("Error creating subscription:",e),{success:!1,error:e.message}}return{success:!0}}catch(e){return console.error("Unexpected error in createOrUpdateUserSubscription:",e),{success:!1,error:"Unexpected error occurred"}}}async function m(e,r){if(!i)return console.log("âœ… Supabase not configured, credits updated in memory"),{success:!0};try{let{error:s}=await u.from("user_subscriptions").update({credits:r,updated_at:new Date().toISOString()}).eq("user_email",e).eq("status","active");if(s)return console.error("Error updating subscription credits:",s),{success:!1,error:s.message};return{success:!0}}catch(e){return console.error("Unexpected error in updateUserSubscriptionCredits:",e),{success:!1,error:"Unexpected error occurred"}}}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},87593:(e,r,s)=>{"use strict";s.d(r,{NB:()=>t,Qh:()=>o});let t={free:{id:"free",name:"Free",price:0,credits:1,description:"Free Try",features:["One free trial per account per day","Basic style options","Access to free Minecraft style image generator","@black-forest-labs/flux-kontext-pro integration","Standard resolution"]},premium:{id:"premium",name:"Premium",price:29,credits:100,description:"Best value for regular users",popular:!0,features:["100 AI photo generations","Advanced background removal","High quality output","Priority email support","Access to all backgrounds"]}},o={shopId:process.env.DODOPAYMENT_SHOP_ID,token:process.env.DODOPAYMENT_TOKEN,premiumPaymentLink:process.env.DODO_PREMIUM_PAYMENT_LINK,webhookSecret:process.env.DODO_WEBHOOK_SECRET};process.env.NEXTAUTH_URL},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var r=require("../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[243,580,398],()=>s(1773));module.exports=t})();